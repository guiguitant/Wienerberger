<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FDES Manager – Wienerberger</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f9f9f9;
      --surface: #ffffff;
      --border: #ebebeb;
      --text: #191919;
      --text-secondary: #6b6b6b;
      --text-muted: #9b9b9b;

      --sidebar-w: 240px;
      --sidebar-bg: #191919;

      --red: #e8392d;
      --red-dark: #c42d22;

      /* Status foreground — consumed by JS inline style="color:var(--s{i})" */
      --s0: #71717a;
      --s1: #b45309;
      --s2: #7c3aed;
      --s3: #1d4ed8;
      --s4: #be185d;
      --s5: #15803d;

      --shadow-sm: 0 1px 3px rgba(0,0,0,.05), 0 1px 2px rgba(0,0,0,.03);
      --shadow-md: 0 4px 16px rgba(0,0,0,.07), 0 1px 3px rgba(0,0,0,.04);
      --shadow-lg: 0 24px 64px rgba(0,0,0,.14), 0 4px 16px rgba(0,0,0,.06);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* ════════════════════ SIDEBAR ════════════════════ */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--sidebar-bg);
      min-height: 100vh;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      padding: 18px 10px;
      z-index: 50;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 8px 18px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      margin-bottom: 14px;
    }
    .brand-icon {
      width: 30px; height: 30px;
      background: var(--red);
      border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 800; color: #fff;
      letter-spacing: .5px; flex-shrink: 0;
    }
    .brand-name {
      font-size: 13.5px; font-weight: 600; color: #fff; letter-spacing: -.1px; line-height: 1.2;
    }
    .brand-name small {
      display: block; font-size: 10.5px; font-weight: 400;
      color: rgba(255,255,255,.3); margin-top: 1px;
    }

    .nav-section-label {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      letter-spacing: .9px; color: rgba(255,255,255,.22);
      padding: 0 8px; margin-bottom: 5px;
    }

    .nav-item {
      display: flex; align-items: center; gap: 9px;
      padding: 7px 8px; border-radius: 7px;
      font-size: 13px; font-weight: 500;
      color: rgba(255,255,255,.5);
      cursor: pointer; text-decoration: none;
      transition: background .12s, color .12s;
    }
    .nav-item:hover { background: rgba(255,255,255,.06); color: rgba(255,255,255,.85); }
    .nav-item.active { background: rgba(255,255,255,.1); color: #fff; }
    .nav-item svg { flex-shrink: 0; }

    .sidebar-footer {
      margin-top: auto;
      padding: 14px 8px 0;
      border-top: 1px solid rgba(255,255,255,.07);
    }
    .sidebar-footer p {
      font-size: 11px; color: rgba(255,255,255,.25); line-height: 1.6;
    }

    /* ════════════════════ CONTENT ════════════════════ */
    .content {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex; flex-direction: column;
    }

    .topbar {
      padding: 32px 36px 0;
    }
    .page-title {
      font-size: 21px; font-weight: 700; letter-spacing: -.4px; line-height: 1;
    }
    .page-sub {
      font-size: 13px; color: var(--text-muted); margin-top: 5px;
    }

    main {
      padding: 24px 36px 60px;
      display: flex; flex-direction: column; gap: 18px;
    }

    /* ════════════════════ STAT CARDS ════════════════════ */
    .stats {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 14px 14px;
      box-shadow: var(--shadow-sm);
      text-align: center;
      transition: box-shadow .2s, transform .2s;
    }
    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .stat-card .num {
      font-size: 28px; font-weight: 700;
      letter-spacing: -.8px; line-height: 1;
    }
    .stat-card .label {
      font-size: 10px; font-weight: 500; color: var(--text-muted);
      margin-top: 6px; text-transform: uppercase; letter-spacing: .7px;
    }

    /* ════════════════════ PROGRESS ════════════════════ */
    .progress-row {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px 22px;
      box-shadow: var(--shadow-sm);
      display: flex; align-items: center; gap: 24px;
    }
    .progress-info { flex-shrink: 0; min-width: 52px; text-align: center; }
    .progress-info .pct-val {
      font-size: 24px; font-weight: 700; letter-spacing: -.5px;
      color: var(--s5); line-height: 1;
    }
    .progress-info .pct-lbl {
      font-size: 10px; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: .6px; margin-top: 3px;
    }
    .progress-divider {
      width: 1px; height: 36px; background: var(--border); flex-shrink: 0;
    }
    .progress-bar-wrap { flex: 1; }
    .progress-bar-label {
      font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;
      font-weight: 500;
    }
    .progress-bar {
      height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #4ade80);
      border-radius: 3px;
      transition: width .5s cubic-bezier(.4,0,.2,1);
    }

    /* ════════════════════ TOOLBAR ════════════════════ */
    .toolbar {
      display: flex; align-items: center; justify-content: space-between;
    }
    h2 { font-size: 14px; font-weight: 600; color: var(--text-secondary); letter-spacing: .1px; }

    /* ════════════════════ BUTTONS ════════════════════ */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 7px 14px; border-radius: 7px;
      font-size: 13px; font-weight: 500; font-family: inherit;
      border: none; cursor: pointer; letter-spacing: -.1px;
      transition: background .15s, box-shadow .15s, transform .1s;
    }
    .btn:active { transform: scale(.98); }

    .btn-primary { background: var(--text); color: #fff; }
    .btn-primary:hover { background: #2a2a2a; box-shadow: 0 2px 10px rgba(0,0,0,.18); }

    .btn-ghost {
      background: transparent; color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { background: #f4f4f4; border-color: #d8d8d8; }

    /* ════════════════════ TABLE ════════════════════ */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px; overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    table { width: 100%; border-collapse: collapse; }

    thead tr { background: #fafafa; border-bottom: 1px solid var(--border); }
    th {
      text-align: left; padding: 10px 16px;
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: .7px; color: var(--text-muted);
    }
    td {
      padding: 12px 16px; font-size: 13.5px;
      border-bottom: 1px solid #f4f4f4; vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tbody tr { transition: background .1s; cursor: pointer; }
    tbody tr:hover td { background: #fafafa; }

    /* ════════════════════ STATUS BADGE ════════════════════ */
    .status-badge {
      display: inline-flex; align-items: center;
      border-radius: 6px; overflow: hidden;
      font-size: 12px; font-weight: 500; white-space: nowrap;
    }

    /* Tinted backgrounds (class set by JS) */
    .s0 { background: #f4f4f5; }
    .s1 { background: #fef3c7; }
    .s2 { background: #ede9fe; }
    .s3 { background: #dbeafe; }
    .s4 { background: #fce7f3; }
    .s5 { background: #dcfce7; }

    .status-select {
      appearance: none; -webkit-appearance: none;
      border: none; background: transparent;
      font-family: inherit; font-size: 12px; font-weight: 500;
      cursor: pointer; padding: 5px 26px 5px 10px; border-radius: 6px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(0,0,0,.28)'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 8px center;
    }
    .status-select option { color: #191919; background: #fff; }

    /* Per-status text colours (override JS-set white) */
    .s0 .status-select { color: #71717a; }
    .s1 .status-select { color: #b45309; }
    .s2 .status-select { color: #7c3aed; }
    .s3 .status-select { color: #1d4ed8; }
    .s4 .status-select { color: #be185d; }
    .s5 .status-select { color: #15803d; }

    /* ════════════════════ ACTIONS ════════════════════ */
    .actions { display: flex; gap: 4px; }
    .btn-icon {
      background: none; border: 1px solid transparent;
      border-radius: 6px; width: 28px; height: 28px;
      display: inline-flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-muted);
      transition: background .12s, color .12s, border-color .12s;
    }
    .btn-icon:hover { background: #fff1f1; color: #e11d48; border-color: #fecdd3; }

    /* ════════════════════ EMPTY STATE ════════════════════ */
    .empty {
      text-align: center; padding: 64px 24px; color: var(--text-muted);
    }
    .empty-icon {
      width: 48px; height: 48px; background: #f4f4f4;
      border-radius: 12px; display: flex; align-items: center;
      justify-content: center; margin: 0 auto 14px;
    }
    .empty p { font-size: 13.5px; line-height: 1.7; }
    .empty strong { color: var(--text); }

    /* ════════════════════ MODAL ════════════════════ */
    .overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(3px);
      z-index: 200; align-items: center; justify-content: center;
      padding: 16px;
    }
    .overlay.open { display: flex; }

    .modal {
      background: var(--surface); border-radius: 14px;
      width: 100%; max-width: 420px;
      box-shadow: var(--shadow-lg);
      animation: pop .2s cubic-bezier(.34,1.4,.64,1);
      overflow: hidden;
    }
    @keyframes pop {
      from { transform: scale(.93) translateY(10px); opacity: 0; }
      to   { transform: scale(1) translateY(0); opacity: 1; }
    }

    .modal-header {
      padding: 20px 22px 16px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h3 { font-size: 15px; font-weight: 600; letter-spacing: -.1px; }

    .modal-body { padding: 20px 22px; display: flex; flex-direction: column; gap: 16px; }

    .modal-footer {
      padding: 14px 22px; background: #fafafa;
      border-top: 1px solid var(--border);
      display: flex; justify-content: flex-end; gap: 8px;
    }

    label {
      font-size: 12px; font-weight: 600; color: var(--text-secondary);
      display: block; margin-bottom: 6px; letter-spacing: .1px;
    }

    input[type="text"], input[type="date"], select.form-select {
      width: 100%; padding: 9px 12px;
      border: 1px solid var(--border); border-radius: 7px;
      font-size: 13.5px; font-family: inherit;
      color: var(--text); background: #fff;
      transition: border-color .15s, box-shadow .15s;
    }
    input[type="text"]:focus, input[type="date"]:focus, select.form-select:focus {
      outline: none; border-color: #a0a0a0;
      box-shadow: 0 0 0 3px rgba(0,0,0,.06);
    }
    input[type="text"]::placeholder { color: #c8c8c8; }

    .err { font-size: 12px; color: var(--red); margin-top: 5px; display: none; }
    .err.show { display: block; }

    /* Deadline indicator */
    .deadline-chip {
      display: inline-block; padding: 3px 8px;
      border-radius: 5px; font-size: 12px; font-weight: 500;
    }
    .dl-ok   { background: #dcfce7; color: #15803d; }
    .dl-warn { background: #fef9c3; color: #a16207; }
    .dl-late { background: #fee2e2; color: #dc2626; }

    /* ════════════════════ DETAIL VIEW ════════════════════ */
    #viewDetail { display: none; }

    .detail-back {
      display: inline-flex; align-items: center; gap: 7px;
      margin-bottom: 6px;
    }
    .detail-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      padding: 32px 36px;
      max-width: 560px;
    }
    .detail-name {
      font-size: 19px; font-weight: 700; letter-spacing: -.3px;
      color: var(--text); margin-bottom: 28px;
    }
    .detail-field {
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 9px;
    }
    .detail-field:first-of-type { padding-top: 0; }
    .detail-field:last-of-type  { border-bottom: none; padding-bottom: 0; }
    .detail-field-label {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: .7px; color: var(--text-muted);
    }

    /* ════════════════════ RESPONSIVE ════════════════════ */
    @media (max-width: 960px) {
      .stats { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 700px) {
      .sidebar { display: none; }
      .content { margin-left: 0; }
      .topbar, main { padding-left: 20px; padding-right: 20px; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .progress-row { flex-wrap: wrap; }
      .progress-divider { display: none; }
    }
    @media (max-width: 480px) {
      th:first-child, td:first-child { display: none; }
    }
  </style>
</head>
<body>

<!-- ══════════ SIDEBAR ══════════ -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <div class="brand-icon">WB</div>
    <div class="brand-name">
      FDES Manager
      <small>Wienerberger</small>
    </div>
  </div>

  <div class="nav-section-label">Espace de travail</div>

  <a class="nav-item active" href="#">
    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
      <rect x=".5" y=".5" width="5.5" height="5.5" rx="1.2" fill="currentColor"/>
      <rect x="8" y=".5" width="5.5" height="5.5" rx="1.2" fill="currentColor"/>
      <rect x=".5" y="8" width="5.5" height="5.5" rx="1.2" fill="currentColor"/>
      <rect x="8" y="8" width="5.5" height="5.5" rx="1.2" fill="currentColor"/>
    </svg>
    Dashboard
  </a>

  <div class="sidebar-footer">
    <p>Chef de projet<br>Wienerberger France</p>
  </div>
</aside>

<!-- ══════════ MAIN CONTENT ══════════ -->
<div class="content">

  <div id="viewDashboard">
  <div class="topbar">
    <div class="page-title">Dashboard</div>
    <div class="page-sub">Vue d'ensemble de vos fiches environnementales</div>
  </div>

  <main>

    <!-- Stat cards (rendered by JS) -->
    <div class="stats" id="stats"></div>

    <!-- Progress bar -->
    <div class="progress-row" id="progressRow" style="display:none">
      <div class="progress-info">
        <div class="pct-val" id="progressPct">0%</div>
        <div class="pct-lbl">Vérifiées</div>
      </div>
      <div class="progress-divider"></div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-label">Avancement global — FDES au statut Vérifié</div>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <h2>Mes FDES</h2>
      <button class="btn btn-primary" onclick="openModal()">
        <svg width="11" height="11" viewBox="0 0 11 11" fill="none">
          <path d="M5.5 1v9M1 5.5h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Nouvelle FDES
      </button>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:44px">#</th>
            <th>Nom du produit</th>
            <th style="width:210px">Statut</th>
            <th style="width:140px">Deadline</th>
            <th style="width:120px">Ajoutée le</th>
            <th style="width:48px"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="empty" id="empty" style="display:none">
        <div class="empty-icon">
          <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
            <rect x="3" y="2" width="16" height="18" rx="2" stroke="#9b9b9b" stroke-width="1.5"/>
            <path d="M7 7h8M7 11h8M7 15h5" stroke="#9b9b9b" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <p>Aucune FDES pour l'instant.<br>Cliquez sur <strong>Nouvelle FDES</strong> pour commencer.</p>
      </div>
    </div>

  </main>
  </div><!-- /viewDashboard -->

  <div id="viewDetail">
    <div class="topbar">
      <button class="btn btn-ghost detail-back" onclick="closeDetail()">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M9 2L4 7l5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Retour au dashboard
      </button>
    </div>
    <main>
      <div class="detail-card" id="detailCard"></div>
    </main>
  </div><!-- /viewDetail -->

</div>

<!-- ══════════ MODAL ══════════ -->
<div class="overlay" id="overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <h3>Nouvelle FDES</h3>
      <button class="btn-icon" onclick="closeModal()" title="Fermer">
        <svg width="11" height="11" viewBox="0 0 11 11" fill="none">
          <path d="M1 1l9 9M10 1L1 10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div>
        <label for="inputName">Nom du produit</label>
        <input type="text" id="inputName" placeholder="ex. Brique Porotherm 20" maxlength="100" />
        <div class="err" id="errName">Ce champ est requis.</div>
      </div>
      <div>
        <label for="inputStatus">Statut initial</label>
        <select class="form-select" id="inputStatus">
          <option value="0">Lancement</option>
          <option value="1">En cours de collecte</option>
          <option value="2">En cours de modélisation</option>
          <option value="3">En cours de rapport</option>
          <option value="4">En cours de vérification</option>
          <option value="5">Vérifié</option>
        </select>
      </div>
      <div>
        <label for="inputDeadline">Deadline cible</label>
        <input type="date" id="inputDeadline" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="addFdes()">Ajouter</button>
    </div>
  </div>
</div>

<script>
  const STATUSES = [
    'Lancement',
    'En cours de collecte',
    'En cours de modélisation',
    'En cours de rapport',
    'En cours de vérification',
    'Vérifié'
  ];

  const STAT_LABELS = [
    'Lancement', 'Collecte', 'Modélisation', 'Rapport', 'Vérification', 'Vérifié'
  ];

  let fdes = JSON.parse(localStorage.getItem('fdes') || '[]');

  function save() {
    localStorage.setItem('fdes', JSON.stringify(fdes));
  }

  function fmt(iso) {
    return new Date(iso).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }

  // ── Detail view ──
  let currentDetailIdx = null;

  function openDetail(idx) {
    currentDetailIdx = idx;
    renderDetail(idx);
    document.getElementById('viewDashboard').style.display = 'none';
    document.getElementById('viewDetail').style.display = 'block';
  }

  function closeDetail() {
    currentDetailIdx = null;
    document.getElementById('viewDashboard').style.display = '';
    document.getElementById('viewDetail').style.display = 'none';
  }

  function renderDetail(idx) {
    const f = fdes[idx];
    document.getElementById('detailCard').innerHTML = `
      <div class="detail-name">${escHtml(f.name)}</div>
      <div class="detail-field">
        <div class="detail-field-label">Statut</div>
        <span class="status-badge s${f.status}" style="font-size:13px">
          <select class="status-select" style="font-size:13px;padding:7px 28px 7px 12px"
                  onchange="changeStatusFromDetail(${idx}, this.value)">
            ${STATUSES.map((s, si) => `<option value="${si}" ${si === f.status ? 'selected' : ''}>${s}</option>`).join('')}
          </select>
        </span>
      </div>
      <div class="detail-field">
        <div class="detail-field-label">Deadline</div>
        ${deadlineChip(f.deadline)}
      </div>
      <div class="detail-field">
        <div class="detail-field-label">Ajoutée le</div>
        <span style="font-size:14px;color:var(--text-secondary)">${fmt(f.createdAt)}</span>
      </div>
    `;
  }

  function changeStatusFromDetail(idx, val) {
    fdes[idx].status = parseInt(val);
    save();
    render();
    renderDetail(idx);
  }

  function deadlineChip(deadline) {
    if (!deadline) return '<span style="color:var(--text-muted);font-size:12px">—</span>';
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const dl = new Date(deadline + 'T00:00:00');
    const diff = Math.round((dl - today) / 86400000);
    if (diff < 0)   return `<span class="deadline-chip dl-late">Dépassée (${Math.abs(diff)}j)</span>`;
    if (diff <= 7)  return `<span class="deadline-chip dl-warn">Dans ${diff} jour${diff > 1 ? 's' : ''}</span>`;
    return `<span class="deadline-chip dl-ok">${dl.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit', year:'numeric'})}</span>`;
  }

  function render() {
    const tbody = document.getElementById('tbody');
    const empty = document.getElementById('empty');
    const stats = document.getElementById('stats');
    const progressRow = document.getElementById('progressRow');

    // Stats
    const counts = [0, 0, 0, 0, 0, 0];
    fdes.forEach(f => counts[f.status]++);

    stats.innerHTML = counts.map((c, i) =>
      `<div class="stat-card">
        <div class="num s${i}" style="color:var(--s${i})">${c}</div>
        <div class="label">${STAT_LABELS[i]}</div>
      </div>`
    ).join('');

    // Progress bar (% of Vérifié)
    if (fdes.length > 0) {
      progressRow.style.display = '';
      const pct = Math.round((counts[5] / fdes.length) * 100);
      document.getElementById('progressPct').textContent = pct + '%';
      document.getElementById('progressFill').style.width = pct + '%';
    } else {
      progressRow.style.display = 'none';
    }

    // Table
    if (fdes.length === 0) {
      tbody.innerHTML = '';
      empty.style.display = '';
      return;
    }
    empty.style.display = 'none';

    tbody.innerHTML = fdes.map((f, i) => `
      <tr onclick="openDetail(${i})">
        <td style="color:var(--text-muted);font-size:12px">${String(i + 1).padStart(2, '0')}</td>
        <td style="font-weight:500">${escHtml(f.name)}</td>
        <td onclick="event.stopPropagation()">
          <span class="status-badge s${f.status}">
            <select class="status-select" onchange="changeStatus(${i}, this.value)">
              ${STATUSES.map((s, si) => `<option value="${si}" ${si === f.status ? 'selected' : ''}>${s}</option>`).join('')}
            </select>
          </span>
        </td>
        <td>${deadlineChip(f.deadline)}</td>
        <td style="color:var(--text-muted);font-size:13px">${fmt(f.createdAt)}</td>
        <td onclick="event.stopPropagation()">
          <div class="actions">
            <button class="btn-icon" onclick="deleteFdes(${i})" title="Supprimer">
              <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M2 3h9M5 3V2h3v1M3 3l.7 8h5.6L10 3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function changeStatus(idx, val) {
    fdes[idx].status = parseInt(val);
    save();
    render();
  }

  function deleteFdes(idx) {
    const name = fdes[idx].name;
    if (confirm(`Supprimer la FDES "${name}" ?`)) {
      fdes.splice(idx, 1);
      save();
      render();
    }
  }

  // Modal
  function openModal() {
    document.getElementById('overlay').classList.add('open');
    document.getElementById('inputName').value = '';
    document.getElementById('inputStatus').value = '0';
    document.getElementById('inputDeadline').value = '';
    document.getElementById('errName').classList.remove('show');
    setTimeout(() => document.getElementById('inputName').focus(), 50);
  }

  function closeModal() {
    document.getElementById('overlay').classList.remove('open');
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('overlay')) closeModal();
  }

  function addFdes() {
    const name = document.getElementById('inputName').value.trim();
    const status = parseInt(document.getElementById('inputStatus').value);
    const err = document.getElementById('errName');

    if (!name) { err.classList.add('show'); return; }
    err.classList.remove('show');

    const deadline = document.getElementById('inputDeadline').value;
    fdes.push({ name, status, deadline, createdAt: new Date().toISOString() });
    save();
    render();
    closeModal();
  }

  // Keyboard support
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (document.getElementById('overlay').classList.contains('open')) closeModal();
      else if (currentDetailIdx !== null) closeDetail();
    }
    if (e.key === 'Enter' && document.getElementById('overlay').classList.contains('open')) addFdes();
  });

  render();
</script>
</body>
</html>
